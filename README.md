# Ethers Simple Storage

A study/learning project demonstrating a minimal end-to-end flow of compiling, deploying, and interacting with a Solidity contract using Ethers v6 and a local Ganache JSON-RPC node.

## Stack & Technologies

- Solidity (0.8.x) — smart contract language
- solc / solcjs — Solidity compiler
- Node.js (ESM) — runtime environment
- TypeScript — authoring the deploy script (run via `ts-node` or compile first)
- Ethers v6 — Ethereum client library
- Ganache — local Ethereum JSON-RPC node
- dotenv — environment variables management

## Project Structure

- `SimpleStorage.sol` — Solidity contract
- `SimpleStorage_sol_SimpleStorage.abi` — ABI generated by solc
- `SimpleStorage_sol_SimpleStorage.bin` — bytecode generated by solc
- `deploy.ts` — deployment & interaction script using Ethers v6
- `package.json` — dependencies and scripts
- `tsconfig.json` — TypeScript configuration (NodeNext ESM)

## Prerequisites

- Node.js 18+
- Ganache running locally (default: `http://127.0.0.1:7545`)

## Setup

1. Install dependencies

```bash
npm install
```

2. Create a `.env` file (runtime password is provided via env at execution time)

```env
RPC_URL=http://127.0.0.1:7545
# Do NOT put the password here; you'll pass it at runtime

# To use Alchemy instead of Ganache, set your RPC to the Alchemy endpoint, for example:
# RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_ALCHEMY_API_KEY
```

3. Compile the contract (generates `.abi` and `.bin`)

```bash
npx solcjs --bin --abi --include-path node_modules/ --base-path . -o . SimpleStorage.sol
```

## Run

You can run the deploy script via ts-node:

```bash
PRIVATE_KEY_PASSWORD=your-strong-password npx ts-node deploy.ts
```

Or compile then run with Node.js:

```bash
PRIVATE_KEY_PASSWORD=your-strong-password npx tsc deploy.ts
PRIVATE_KEY_PASSWORD=your-strong-password node deploy.js
```

## Generate Encrypted Keystore (encryptedKey)

You can encrypt your private key into a password-protected keystore JSON using Ethers v6.

1. Ensure your `.env` contains only the RPC URL:

```env
RPC_URL=http://127.0.0.1:7545
```

2. Use the helper script `encryptKey.ts`:

```ts
// encryptKey.ts (simplified)
import { ethers } from "ethers";
import "dotenv/config";

async function main() {
  const pk = process.env.PRIVATE_KEY;
  const pass = process.env.PRIVATE_KEY_PASSWORD;
  if (!pk) throw new Error("Missing PRIVATE_KEY in .env");
  if (!pass) throw new Error("Missing PRIVATE_KEY_PASSWORD in .env");

  const wallet = new ethers.Wallet(pk);
  const keystoreJson = await wallet.encrypt(pass);
  console.log(keystoreJson);
}

main();
```

3. Run it (provide the password at runtime):

```bash
PRIVATE_KEY_PASSWORD=your-strong-password npx ts-node encryptKey.ts
```

4. Save the JSON output securely (do NOT commit it). You can later decrypt with:

```ts
const wallet = await ethers.Wallet.fromEncryptedJson(keystoreJson, password);
```

Tips:

- Use a strong password; keep it outside of version control.
- `.gitignore` already ignores common secrets and artifacts; ensure your keystore JSON is also ignored or stored safely elsewhere.
- Never commit your raw `PRIVATE_KEY` to Git.

## What the Script Does

- Connects to the local JSON-RPC provider using `RPC_URL`
- Creates a wallet from `PRIVATE_KEY`
- Reads ABI and bytecode, builds a `ContractFactory`
- Deploys the SimpleStorage contract and waits for 1 confirmation
- Calls `retrieve()` to read the current value
- Calls `store(7)` to update the value, waits for confirmation, then reads again

## Deployed Contract (via Alchemy)

- Network: Sepolia
- Contract address: `0x402f4F6EA6F6e4759Fa8E0055DB7746Cc5d359A8`
- Etherscan: https://sepolia.etherscan.io/address/0x402f4F6EA6F6e4759Fa8E0055DB7746Cc5d359A8#code

## Common Issues & Fixes

- ECONNREFUSED 127.0.0.1:7545

  - Ganache is not running or wrong `RPC_URL`. Start Ganache and verify the URL.

- invalid opcode / missing revert data during deploy

  - Recompile the contract to refresh `.abi`/`.bin`. Ensure the bytecode starts with `0x` and ABI matches.

- Ethers types don’t include contract methods (TypeScript error)

  - Ensure ABI is parsed as JSON. If needed, temporarily cast: `(contract as any).method()`.

- Module warnings about ESM

  - Add `"type": "module"` to `package.json` and set `"module": "nodenext", "moduleResolution": "nodenext"` in `tsconfig.json`.

- Nonce mismatch ("account has nonce X, tx has nonce Y")
  - Restart Ganache, or pass the pending nonce explicitly:
    ```ts
    const nonce = await provider.getTransactionCount(
      await wallet.getAddress(),
      "pending"
    );
    await(contract as any).store(7, { nonce });
    ```

## Notes

- This repo uses Ethers v6; method names and return types differ from v5.
- For production-grade typing, consider generating contract typings (e.g., TypeChain).

## License

MIT
